name: SHACL Validation CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate-kg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyshacl

      - name: Run SHACL Validation
        # continue-on-error: true is necessary because the -w flag 
        # makes pyshacl exit with an error code if the data is invalid.
        # This allows the subsequent steps to run and show the report.
        continue-on-error: true
        run: |
          cd scripts
          pyshacl -s ../tests/shacl_shapes.ttl -i rdfs -f human -w -o shacl_report.txt ../kg/makaao_kg_sample.rdf
        
      - name: Check Validation Results
        # This step looks at the report file generated by the previous step.
        # If it finds "Conforms: False", it prints the report and fails the CI.
        run: |
          if grep -q "Conforms: False" scripts/shacl_report.txt; then
            echo "-------------------------------------------------------"
            echo "❌ SHACL VALIDATION FAILED"
            echo "-------------------------------------------------------"
            cat scripts/shacl_report.txt
            exit 1
          else
            echo "-------------------------------------------------------"
            echo "✅ SHACL VALIDATION PASSED"
            echo "-------------------------------------------------------"
            cat scripts/shacl_report.txt
          fi

      - name: Upload Report Artifact
        # This ensures the report file is available for download in the 
        # GitHub Actions 'Summary' tab, even if the validation failed.
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shacl-validation-report
          path: scripts/shacl_report.txt